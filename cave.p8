pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
--main

node = {
	x = 0,
	y = 0,
	sp = 68,
	new = function(self,x,y)
		local obj = {x=x,y=y}
		return setmetatable(obj, {__index=self})
	end,
	
	draw = function(self)
		spr(self.sp, self.x, self.y)
	end,

}

nodes = {}

silt_timer = 0
silt_max = 80
silt_sz_up = 5
--base functions

function _init()
	pl.x = 20
	--decomp(-5,-5,132,132,ti,0)
end

function _update()
	
	local last_x=pl.x
	local last_y=pl.y
	
	if btn(â¬†ï¸) then pl.y-=pl.spe end
	if btn(â¬‡ï¸) then pl.y+=pl.spe end
	if btn(â¬…ï¸) then pl.x-=pl.spe end
	if btn(âž¡ï¸) then pl.x+=pl.spe end
	if btnp(âŽ) and btnp(ðŸ…¾ï¸) then drop_node(pl.x, pl.y) end
	
	
	if map_colliding(pl.x,pl.y) then
		--[[ ideal: have some sort of 
							feedback that the player
							moving back to their 
							last position
			--]]
		pl.x = last_x 
		pl.y = last_y
		start_silt_time()
	end
	
	if silt_timer > 0 then
		silt_timer-=1
		silt_sz_up+=0.8
	else
		silt_timer = 0
	end
	
end

function _draw()
	cls(0)
	camera(pl.x-64,pl.y-64)
--	map(0,0,-64,-64)
	map()
	spr(64,pl.x,pl.y,2,2)
	-- collision shape debugging--
	rect(pl.x+4, pl.y+4, pl.x + 10, pl.y+6, 8)
	
	-- raycast debug
	flash(pl.x, pl.y, 0, 50)
	
	--draw nodes--
	foreach(nodes, node.draw)
	
--	c = cocreate(make_silt)
--	while costatus(c) =="suspended" and costatus(c)~="dead" do 
	if silt_timer > 0 then
 	fillp(0b0011010101101000.100)
		circfill(pl.x, pl.y, silt_sz_up, 1)
		fillp(0)
	end 
end


--helper functions
function drop_node(x,y)
	if pl.node_ct>0 then
		pl.node_ct-=1
		
		add(nodes, node.new(node,x,y))
	else
		return
	end
end

function map_colliding(obj_x, obj_y)
	--[[ currently only able to do a 
						rectangle, but would like 
						to make an ellipse or smth					
	]] 
	local x1 = (obj_x+4)\8 --prev:+2
	local y1 = (obj_y+4)\8 --prev: +4
	local x2 = (obj_x+10)\8 --prev:+12
	local y2 = (obj_y+6)\8  --prev: +6
	
	local a = fget(mget(x1, y1),0)
	local b = fget(mget(x1, y2),0)
	local c = fget(mget(x2, y2),0)
	local d = fget(mget(x2, y1),0)
	
	if a or b or c or d then
		return true
	else 
		return false
	end
end

function flash(sx,sy,a,l)
	local r = 0.07 --cone angle width
	local p = ceil(sin(-r)*2.6*l)--partitions
	local i = -p/2
	
	local pts = {}
	while i<=(p/2) do
		local res = raycast(sx, sy, a+r*i/(p/2),l)
		add(pts,res)
		--line(sx, sy, res.x, res.y, l)
		
		i+=1
	end

end

function decomp(sx,sy,w,h,s,d)--d is default -1 is pass
	local l = split(s,"-",false)
	
	local curr = 1
	local c=d
	local n=0
	
	for y=0, h do
		for x=0, w do
			--check for next num
			if n==0 then
				
				if curr == #l then
					return true
				end
				
				local tn=split(l[curr],"x")
				if #tn==1 then
					c=d
					n=tn[1]
				else
					c=tn[1]
					n=tn[2]
				end
				curr+=1
			end
			
			if c!=-1 then
				pset(sx+x,sy+y,c)
			end
			n-=1
		end
	end
	
end

--startx, starty, angle 0-1, length
function raycast(sx,sy,a,l)
	local d = 1 --change in length
	local c = d -- curr length
	
	while c < l do
		local cx = sx+cos(a)*c
		local cy = sy+sin(a)*c
		
		pset(cx,cy,11)
		if fget(mget(cx/8,cy/8),0) then
			return {x=cx,y=cy}
		end
		
		c+=d
	end
	return {x = sx+cos(a)*l, y = sy+sin(a)*l}
end

function start_silt_time()
	if silt_timer == 0 then
		silt_timer = silt_max
		silt_sz_up = 5
	end
end

function make_silt()
	for i = 0, 75 do circfill(pl.x, pl.y, i, 0x4f) yield() end
end 

-->8
--player

pl = {
	x = 0,
	y = 0,
	node_ct = 20,
	spe = 4,
	
	draw = function(self)
		
	end
}
-->8
--comp vars
--title screen (assume black)
ti="1256-8x14-115-8x22-108-8x28-103-8x32-99-8x36-95-8x40-91-8x44-88-8x46-86-8x48-83-8x52-80-8x54-78-8x56-76-8x58-74-8x60-73-8x60-72-8x62-70-8x64-68-8x66-67-8x66-66-8x68-65-8x68-64-8x70-63-8x70-62-8x72-61-8x72-60-8x74-59-8x74-59-8x74-58-8x76-57-8x76-57-8x76-57-8x76-56-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-55-8x78-56-8x76-57-8x76-57-8x76-57-8x76-58-8x74-59-8x74-59-8x74-60-8x31-2x10-8x31-61-8x29-2x14-8x29-62-8x26-2x5-1x8-2x5-8x26-63-8x24-2x5-1x12-2x5-8x24-64-8x21-2x5-1x16-2x5-8x21-65-8x20-2x4-1x20-2x4-8x20-66-8x18-2x4-1x22-2x4-8x18-67-8x18-2x3-1x10-4-1x10-2x3-8x18-68-8x17-2x2-1x10-6-1x10-2x2-8x17-70-8x15-2x3-1x2-3-1x5-6-1x5-3-1x2-2x3-8x15-72-8x14-2x3-1x1-5-1x3-8-1x3-5-1x1-2x3-8x14-73-8x14-2x3-1x1-5-1x3-8-1x3-5-1x1-2x3-8x14-74-8x10-2x6-1x1-5-1x3-8-1x3-5-1x1-2x6-8x10-76-8x7-2x8-1x2-3-1x4-5-1x2-1-1x4-3-1x2-2x8-8x7-78-8x5-2x4-1x3-2x3-1x8-8-1x8-2x3-1x3-2x4-8x5-80-8x4-2x3-1x7-2x2-1x6-8-1x6-2x2-1x7-2x3-8x4-83-8x2-2x2-1x10-2x2-1x4-8-1x4-2x2-1x10-2x2-8x2-86-8x1-2x2-1x16-8-1x16-2x2-8x1-44-2x46-1x40-2x47-44-2x1-1x42-2x1-8x10-71-8x7-1-2x1-1x42-2x1-8x6-77-8x6-1-1x42-1-8x2-86-8x1-3-1x38-3-8x1-86-8x2-5-1x34-5-8x2-85-8x2-10-1x24-84-8x4-28-1x10-57-1x5-42-8x2-44-8x2-83-8x4-44-8x4-50-1x9-2-1x4-15-8x5-44-8x5-2-1x16-57-8x9-121-8x12-121-8x6-59-8x4-69-1x7-44-8x1-132-8x1-132-8x8-59-8x3-11-8x8-46-8x8-2-1x3-49-8x9-7-8x9-44-8x10-53-8x8-15-8x3-44-8x13-73-8x4-42-8x7-73-1x6-8x7-38-8x19-4-8x3-11-1x8-7-1x5-25-8x5-5-8x6-32-8x2-4-8x14-58-8x20-35-8x18-59-8x24-32-8x15-65-8x22-30-8x14-73-8x16-30-8x9-12-8x6-50-8x15-4-8x7-50-8x8-56-8x20-51-8x3-59-8x21-26-8x10-15-1x3-1-1x14-24-1x7-12-8x23-22-8x23-67-8x23-18-8x26-72-8x19-14-8x32-78-8x11-10-8x37-89-8x10-20-8x16-39-8x7-38-8x7-12-8x21-69-8x9-7-8x3-110-8x59-21-1x4-46-8x70-60-8x28-6-8x14-9-8x18-54-8x33-3-8x16-14-8x8-58-8x19-8-8x22-35-8x8-19-1x6-27-8x6-8-8x16-41-8x6-10-1x10-32-8x70-16-8x2-45-8x74-53-8x4-10-8x71-66-8x70-1x2-78-8x50-38-1x10-41-8x22-3-8x22-51-8x12-20-8x15-7-8x20-59-8x68-67-8x53-85-8x66-74-8x37-101-8x35"

--ui assume blank
__gfx__
00000000000000022222222222222222222222222200000000808888008888000000888000000000000000000011110001000010000000000000000000000000
00000000000002222222211112222211222122222220000000800888000888000000088000000000000000000010100001100110001110000000000000000000
00700700000022211122111111111111121111122122200000800e8000088000000008800000000000e0000e0011110001111110011011000000000000000000
00077000000221111111112211112221111111111112220000e0008000088000000000800000e000000800e00011110000111100111111100000000000000000
000770000021112211111222111112211112221111112220000000e00000800000000080e0088000000880800001100000011000100100100000000000000000
0070070002221222122112211111121111222211122121200000000000008000000000e008080000008088000011110000011000010101000000000000000000
000000000221122112221111121111111112111122211122000000000000e0000000000008880000000080000001100000011000000100000000000000000000
00000000211111111111111111111111111111111111211200000000000000000000000008800000000080000111111000111100001110000000000000000000
00000000211111111112211111111111111111111111111200000000000000000000000000000222222222222000000000000000000000000000000000000000
00000000211122111222221111112211122111111111112200111000000000000000000000002000000200000000000000000000000000000000000000000000
00000000221122211222111111111221122111111111122200111000000111100111000000002111110211010020000000000000000000000000000000000000
00000000221112111111111111111111111111111111122201110000000111100111100000002111110210111020000000000000000000000000000000000000
00000000221111111111111111111111111111111221112201100000001111100111100002222222222222222222222000000000000000000000000000000000
00000000221221111111222112211111111112211221111201100110001111000011110000000002000000020000000200000000000000000000000000000000
00000000211221111112222112221111111111221122111200001110000000000001110001111102111100021111110200000000000000000000000000000000
00000000211111111111111111111111111111111111111200000000000000000000000021111102111110021111110200000000000000000000000000000000
00000000211111110000000011111111000000001111111200000000000000000000000022222222222222222222222222222222000000000000000000000000
00000000211212210000000011111111000000001121111201110000000000000011000020002000000200000020000200020000000888800000000000000000
00000000211112210000000011111111000000001122111201111000000000000111000021102111110211111021110011000111088880880000000000000000
00000000221111110000000011111111000000001122112201110000000000000100000001102111110210111021100011001111000000080000000000000000
00000000222111110000000011111111000000001111112200100110000000000000000002222200002200222222000222200222008808800000000000000000
00000000221122110000000011111111000000001221112200001110000001100000000020000002000000020000000200000002080000000000000000000000
00000000221222110000000011111111000000001221111200001100000011100000000021111102111001021111110210000002000888000000000000000000
00000000211111110000000011111111000000001111111200000000000000000000000021111102111111021111110211000002000000000000000000000000
00000000211111221111111111111111111111112211112200000000000000000000000000222222222220022222222222222222000000000000000000000000
00000000221111121111222112211111111112112212122000000000000000000000000000002000000200000002000000020000000000000000000000000000
00000000221112111111222112111221122111112111122000000000000000000000000000002111110211111102000011021111000000000000000000000000
00000000022122111111122211111221112221111111220000000000000000000000000000000011110211111100000011021111000000000000000000000000
00000000002222111111112111111111112211111121220000000000000000000000000000000022222222222200000022222222000000000000000000000000
00000000000222211111111111121111111111211222200000000000000000000000000000000002000000020000000000000002000000000000000000000000
00000000000002221122221111221111111222212220000000000000000000000000000000000002111111020000000011111102000000000000000000000000
00000000000000022222222222222222222222222000000000000000000000000000000000000000222222200000000011111102000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000009a79000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000221100000000000000000009aa9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000221dd00000022222000000000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001111111dd00001122222110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09990111112221100011111111211100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099111122222000011111111122100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00002222222200000011111111288200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99922220022000000021200110288200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00990000220000000222200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000202000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010000000000000000000000010101010100000000000000000000000100010001000000000000000000000001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2315000000001123132305000031321323231405000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000002114232325000000003114232315000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2500004041003123231415000000000031122335000023232323232323232323232323230000000023232323232323232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1305005051000123232323050000000000312305000023232323232323232323232323230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1225000000003133231323230304050000002125000000000000000000000000000023230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000000006312323233232350000012335000000000000000000000000000023230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2305000000000103032323350000000000112500000023232323232323232323232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1425000000001123232335000000000103232500000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2315000000003133333500000103021323233500002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1225000000000008060000002123232323350000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2315000000000000000000003135313335000000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000010303030500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1500000000112313231500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3500000001132323233500000103050000010302040304020304000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000021233531120500002123250000232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1500000031350000212500003123250000232300000000232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2500000000000000112500000021150000232323000000002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2305000000000001232500000021230500002323000000002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323050000000123232305000031232500000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3123150000003123132333050000312305000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0031230500000021233500310500002112232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000212305000031350000012500002123232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000312323050000000000313500002100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000003134350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001040203050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203050001030412232323150000230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0023230323232323231223350000232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000002323232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323230000002323232323232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
