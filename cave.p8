pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
--main

node = {
	x = 0,
	y = 0,
	sp = 68,
	new = function(self,x,y)
		local obj = {x=x,y=y}
		return setmetatable(obj, {__index=self})
	end,
	
	draw = function(self)
		spr(self.sp, self.x, self.y)
	end,

}

nodes = {}

--base functions

function _init()
	pl.x = 20
end

function _update()
	
	local last_x=pl.x
	local last_y=pl.y
	
	if btn(â¬†ï¸) then pl.y-=pl.spe end
	if btn(â¬‡ï¸) then pl.y+=pl.spe end
	if btn(â¬…ï¸) then pl.x-=pl.spe end
	if btn(âž¡ï¸) then pl.x+=pl.spe end
	if btnp(âŽ) and btnp(ðŸ…¾ï¸) then drop_node(pl.x, pl.y) end
	
	
	if is_colliding(pl.x,pl.y) then
		pl.x = last_x
		pl.y = last_y
	end
	
	
end

function _draw()
	cls(0)
	camera(pl.x-64,pl.y-64)
--	map(0,0,-64,-64)
	map()
	spr(64,pl.x,pl.y,2,2)
	-- collision shape debugging--
	rect(pl.x+2, pl.y+4, pl.x + 15, pl.y+9, 8)
	
	-- raycast debug
	flash(pl.x, pl.y, 0, 50)
	
	--draw nodes--
	foreach(nodes, node.draw)
end


--helper functions
function drop_node(x,y)
	if pl.node_ct>0 then
		pl.node_ct-=1
		
		add(nodes, node.new(node,x,y))
	else
		return
	end
end

function is_colliding(obj_x, obj_y)
	local x1 = (obj_x+2)\8
	local y1 = (obj_y+4)\8
	local x2 = (obj_x+15)\8
	local y2 = (obj_y+9)\8
	
	local a = fget(mget(x1, y1),0)
	local b = fget(mget(x1, y2),0)
	local c = fget(mget(x2, y2),0)
	local d = fget(mget(x2, y1),0)
	
	if a or b or c or d then
		return true
	else 
		return false
	end
end

function flash(sx,sy,a,l)
	local r = 0.07 --cone angle width
	local p = ceil(sin(-r)*2.6*l)--partitions
	print(p)
	local i = -p/2
	
	local pts = {}
	while i<=(p/2) do
		local res = raycast(sx, sy, a+r*i/(p/2),l)
		add(pts,res)
		--line(sx, sy, res.x, res.y, l)
		
		i+=1
	end

end

--startx, starty, angle 0-1, length
function raycast(sx,sy,a,l)
	local d = 1 --change in length
	local c = d -- curr length
	
	while c < l do
		local cx = sx+cos(a)*c
		local cy = sy+sin(a)*c
		
		pset(cx,cy,11)
		if fget(mget(cx/8,cy/8),0) then
			return {x=cx,y=cy}
		end
		
		c+=d
	end
	return {x = sx+cos(a)*l, y = sy+sin(a)*l}
end



-->8
--player

pl = {
	x = 0,
	y = 0,
	node_ct = 20,
	spe = 4,
	
	draw = function(self)
		
	end
}
__gfx__
00000000000000022222222222222222222222222200000000808888008888000000888000000000000000000011110001000010000000000000000000000000
00000000000002222222211112222211222122222220000000800888000888000000088000000000000000000010100001100110001110000000000000000000
00700700000022211122111111111111121111122122200000800e8000088000000008800000000000e0000e0011110001111110011011000000000000000000
00077000000221111111112211112221111111111112220000e0008000088000000000800000e000000800e00011110000111100111111100000000000000000
000770000021112211111222111112211112221111112220000000e00000800000000080e0088000000880800001100000011000100100100000000000000000
0070070002221222122112211111121111222211122121200000000000008000000000e008080000008088000011110000011000010101000000000000000000
000000000221122112221111121111111112111122211122000000000000e0000000000008880000000080000001100000011000000100000000000000000000
00000000211111111111111111111111111111111111211200000000000000000000000008800000000080000111111000111100001110000000000000000000
00000000211111111112211111111111111111111111111200000000000000000000000000000222222222222000000000000000000000000000000000000000
00000000211122111222221111112211122111111111112200111000000000000000000000002000000200000000000000000000000000000000000000000000
00000000221122211222111111111221122111111111122200111000000111100111000000002111110211010020000000000000000000000000000000000000
00000000221112111111111111111111111111111111122201110000000111100111100000002111110210111020000000000000000000000000000000000000
00000000221111111111111111111111111111111221112201100000001111100111100002222222222222222222222000000000000000000000000000000000
00000000221221111111222112211111111112211221111201100110001111000011110000000002000000020000000200000000000000000000000000000000
00000000211221111112222112221111111111221122111200001110000000000001110001111102111100021111110200000000000000000000000000000000
00000000211111111111111111111111111111111111111200000000000000000000000021111102111110021111110200000000000000000000000000000000
00000000211111110000000011111111000000001111111200000000000000000000000022222222222222222222222222222222000000000000000000000000
00000000211212210000000011111111000000001121111201110000000000000011000020002000000200000020000200020000000888800000000000000000
00000000211112210000000011111111000000001122111201111000000000000111000021102111110211111021110011000111088880880000000000000000
00000000221111110000000011111111000000001122112201110000000000000100000001102111110210111021100011001111000000080000000000000000
00000000222111110000000011111111000000001111112200100110000000000000000002222200002200222222000222200222008808800000000000000000
00000000221122110000000011111111000000001221112200001110000001100000000020000002000000020000000200000002080000000000000000000000
00000000221222110000000011111111000000001221111200001100000011100000000021111102111001021111110210000002000888000000000000000000
00000000211111110000000011111111000000001111111200000000000000000000000021111102111111021111110211000002000000000000000000000000
00000000211111221111111111111111111111112211112200000000000000000000000000222222222220022222222222222222000000000000000000000000
00000000221111121111222112211111111112112212122000000000000000000000000000002000000200000002000000020000000000000000000000000000
00000000221112111111222112111221122111112111122000000000000000000000000000002111110211111102000011021111000000000000000000000000
00000000022122111111122211111221112221111111220000000000000000000000000000000011110211111100000011021111000000000000000000000000
00000000002222111111112111111111112211111121220000000000000000000000000000000022222222222200000022222222000000000000000000000000
00000000000222211111111111121111111111211222200000000000000000000000000000000002000000020000000000000002000000000000000000000000
00000000000002221122221111221111111222212220000000000000000000000000000000000002111111020000000011111102000000000000000000000000
00000000000000022222222222222222222222222000000000000000000000000000000000000000222222200000000011111102000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000221100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000221dd00000000000000000000a90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001111111dd00000000000000000000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09990111112221100000022222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099111122222000001122222110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00002222222200000011111111211100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99922220022000000011111111122100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00990000220000000011111111288200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000021200110288200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000222200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000202000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010000000000000000000000010101010100000000000000000000000100010001000000000000000000000001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2315000000001123132305000031321323231405000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000002114232325000000003114232315000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2500004041003123231415000000000031122335000023232323232323232323232323230000000023232323232323232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1305005051000123232323050000000000312305000023232323232323232323232323230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1225000000003133231323230304050000002125000000000000000000000000000023230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000000006312323233232350000012335000000000000000000000000000023230000000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2305000000000103032323350000000000112500000023232323232323232323232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1425000000001123232335000000000103232500000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2315000000003133333500000103021323233500002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1225000000000008060000002123232323350000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2315000000000000000000003135313335000000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2335000000010303030500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1500000000112313231500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3500000001132323233500000103050000010302040304020304000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000021233531120500002123250000232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1500000031350000212500003123250000232300000000232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2500000000000000112500000021150000232323000000002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2305000000000001232500000021230500002323000000002323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323050000000123232305000031232500000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3123150000003123132333050000312305000023000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0031230500000021233500310500002112232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000212305000031350000012500002123232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000312323050000000000313500002100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000003134350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000001040203050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203050001030412232323150000230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0023230323232323231223350000232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000002323232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323230000002323232323232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323232300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2323232323232323232323232323000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
